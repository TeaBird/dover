"""
–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ Telegram
–í—Å—ë –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ Railway
"""

import os
import sqlite3
import logging
import asyncio
from datetime import datetime, date, timedelta
from typing import List, Optional, Dict, Any

from fastapi import FastAPI, HTTPException, Form, Query
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from contextlib import asynccontextmanager
from pydantic import BaseModel
from telegram import Bot
from telegram.error import TelegramError
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger

# ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "")
if not TELEGRAM_BOT_TOKEN:
    print("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    print("–°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è")

DATABASE_FILE = "poa.db"
NOTIFICATION_DAYS = [7, 3, 1]  # –ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —É–≤–µ–¥–æ–º–ª—è—Ç—å
CHECK_INTERVAL_HOURS = 6  # –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# ==================== –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–• ====================
class PowerOfAttorneyCreate(BaseModel):
    full_name: str
    poa_type: str
    end_date: date
    telegram_chat_id: Optional[str] = None

class PowerOfAttorney(BaseModel):
    id: int
    full_name: str
    poa_type: str
    start_date: date
    end_date: date
    telegram_chat_id: Optional[str]
    notification_sent: bool
    days_remaining: int

    class Config:
        from_attributes = True

# ==================== –ë–ê–ó–ê –î–ê–ù–ù–´–• ====================
def init_database():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite"""
    conn = sqlite3.connect(DATABASE_FILE)
    cursor = conn.cursor()
    
    # –¢–∞–±–ª–∏—Ü–∞ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS powers_of_attorney (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            full_name TEXT NOT NULL,
            poa_type TEXT NOT NULL,
            start_date DATE NOT NULL,
            end_date DATE NOT NULL,
            telegram_chat_id TEXT,
            notification_sent BOOLEAN DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_end_date ON powers_of_attorney(end_date)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_notification ON powers_of_attorney(notification_sent)')
    
    # –¢–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS logs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            message TEXT,
            level TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    conn.commit()
    conn.close()
    logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

def add_power_of_attorney(
    full_name: str,
    poa_type: str,
    end_date: date,
    telegram_chat_id: Optional[str] = None
) -> int:
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏"""
    conn = sqlite3.connect(DATABASE_FILE)
    cursor = conn.cursor()
    
    cursor.execute('''
        INSERT INTO powers_of_attorney 
        (full_name, poa_type, start_date, end_date, telegram_chat_id)
        VALUES (?, ?, ?, ?, ?)
    ''', (full_name, poa_type, date.today().isoformat(), 
          end_date.isoformat(), telegram_chat_id))
    
    power_id = cursor.lastrowid
    conn.commit()
    conn.close()
    
    logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ID {power_id} –¥–ª—è {full_name}")
    return power_id

def get_all_powers() -> List[Dict[str, Any]]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π"""
    conn = sqlite3.connect(DATABASE_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT *, 
               julianday(end_date) - julianday('now') as days_remaining
        FROM powers_of_attorney 
        ORDER BY end_date ASC
    ''')
    
    powers = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return powers

def get_expiring_powers(days: int) -> List[Dict[str, Any]]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π, –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π"""
    conn = sqlite3.connect(DATABASE_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    
    target_date = (date.today() + timedelta(days=days)).isoformat()
    
    cursor.execute('''
        SELECT * FROM powers_of_attorney 
        WHERE end_date = ? AND notification_sent = 0
    ''', (target_date,))
    
    powers = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return powers

def mark_notification_sent(power_id: int):
    """–ü–æ–º–µ—Ç–∏—Ç—å, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"""
    conn = sqlite3.connect(DATABASE_FILE)
    cursor = conn.cursor()
    
    cursor.execute('''
        UPDATE powers_of_attorney 
        SET notification_sent = 1 
        WHERE id = ?
    ''', (power_id,))
    
    conn.commit()
    conn.close()

def delete_power(power_id: int) -> bool:
    """–£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏"""
    conn = sqlite3.connect(DATABASE_FILE)
    cursor = conn.cursor()
    
    cursor.execute('DELETE FROM powers_of_attorney WHERE id = ?', (power_id,))
    deleted = cursor.rowcount > 0
    
    conn.commit()
    conn.close()
    
    if deleted:
        logger.info(f"–£–¥–∞–ª–µ–Ω–∞ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ID {power_id}")
    
    return deleted

# ==================== TELEGRAM –ë–û–¢ ====================
class TelegramNotifier:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram"""
    
    def __init__(self, token: str):
        self.bot = Bot(token=token) if token else None
        
    async def send_notification(
        self, 
        chat_id: str, 
        full_name: str, 
        poa_type: str, 
        end_date: date, 
        days_left: int
    ) -> bool:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram"""
        if not self.bot:
            logger.warning("Telegram –±–æ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–∫–µ–Ω)")
            return False
            
        try:
            message = (
                f"üîî **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏**\n\n"
                f"**–§–ò–û:** {full_name}\n"
                f"**–¢–∏–ø –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:** {poa_type}\n"
                f"**–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:** {end_date.strftime('%d.%m.%Y')}\n"
                f"**–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π:** {days_left}\n\n"
                f"_–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å!_"
            )
            
            await self.bot.send_message(
                chat_id=chat_id,
                text=message,
                parse_mode="Markdown"
            )
            
            logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram chat_id: {chat_id}")
            return True
            
        except TelegramError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")
            return False

# ==================== –ü–õ–ê–ù–ò–†–û–í–©–ò–ö ====================
class NotificationScheduler:
    """–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ä–æ–∫–æ–≤"""
    
    def __init__(self, notifier: TelegramNotifier):
        self.notifier = notifier
        self.scheduler = AsyncIOScheduler()
        
    async def check_and_notify(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
        if not self.notifier.bot:
            logger.warning("Telegram –±–æ—Ç –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É")
            return
            
        logger.info("–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π...")
        
        for days in NOTIFICATION_DAYS:
            expiring_powers = get_expiring_powers(days)
            
            for power in expiring_powers:
                if power['telegram_chat_id']:
                    success = await self.notifier.send_notification(
                        chat_id=power['telegram_chat_id'],
                        full_name=power['full_name'],
                        poa_type=power['poa_type'],
                        end_date=datetime.strptime(power['end_date'], '%Y-%m-%d').date(),
                        days_left=days
                    )
                    
                    if success:
                        mark_notification_sent(power['id'])
                        
            logger.info(f"–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞ {days} –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥. –ù–∞–π–¥–µ–Ω–æ: {len(expiring_powers)}")
    
    def start(self):
        """–ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00
        self.scheduler.add_job(
            self.check_and_notify,
            CronTrigger(hour=10, minute=0),
            id="daily_check",
            replace_existing=True
        )
        
        # –ê —Ç–∞–∫–∂–µ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        self.scheduler.add_job(
            self.check_and_notify,
            'interval',
            hours=CHECK_INTERVAL_HOURS,
            id="interval_check",
            replace_existing=True
        )
        
        self.scheduler.start()
        logger.info(f"–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00 –∏ –∫–∞–∂–¥—ã–µ {CHECK_INTERVAL_HOURS} —á–∞—Å–æ–≤")

# ==================== FASTAPI –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ====================
# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
telegram_notifier = TelegramNotifier(TELEGRAM_BOT_TOKEN)
scheduler = NotificationScheduler(telegram_notifier)

@asynccontextmanager
async def lifespan(app: FastAPI):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    # –ó–∞–ø—É—Å–∫
    logger.info("–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...")
    init_database()
    scheduler.start()
    
    # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    await scheduler.check_and_notify()
    
    yield
    
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
    logger.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...")
    scheduler.scheduler.shutdown()

app = FastAPI(
    title="–¢—Ä–µ–∫–µ—Ä –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π",
    description="–ü—Ä–æ—Å—Ç–æ–π –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ Telegram",
    version="1.0.0",
    lifespan=lifespan
)

# ==================== HTML –ò–ù–¢–ï–†–§–ï–ô–° ====================
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        function updateCountdown() {
            document.querySelectorAll('.countdown').forEach(el => {
                const endDate = new Date(el.dataset.endDate);
                const today = new Date();
                const diffTime = endDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let badgeClass = 'bg-green-100 text-green-800';
                if (diffDays <= 3) badgeClass = 'bg-red-100 text-red-800';
                else if (diffDays <= 7) badgeClass = 'bg-yellow-100 text-yellow-800';
                
                el.innerHTML = `
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${badgeClass}">
                        ${diffDays} –¥–Ω–µ–π
                    </span>
                `;
            });
        }
        
        async function deletePower(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å?')) {
                const response = await fetch(`/api/powers/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    location.reload();
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            updateCountdown();
            setInterval(updateCountdown, 60000); // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            
            // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('addForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = {
                    full_name: formData.get('full_name'),
                    poa_type: formData.get('poa_type'),
                    end_date: formData.get('end_date'),
                    telegram_chat_id: formData.get('telegram_chat_id') || null
                };
                
                const response = await fetch('/api/powers/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏');
                }
            });
        });
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-file-contract mr-2"></i>–¢—Ä–µ–∫–µ—Ä –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π
            </h1>
            <p class="text-gray-600">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ä–æ–∫–æ–≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ Telegram</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-plus-circle mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                    </h2>
                    <form id="addForm">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">–§–ò–û *</label>
                            <input type="text" name="full_name" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">–¢–∏–ø –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ *</label>
                            <select name="poa_type" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                <option value="–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è">–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è</option>
                                <option value="–†–∞–∑–æ–≤–∞—è">–†–∞–∑–æ–≤–∞—è</option>
                                <option value="–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è">–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è</option>
                                <option value="–ù–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¢–ú–¶">–ù–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¢–ú–¶</option>
                                <option value="–ù–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤">–ù–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è *</label>
                            <input type="date" name="end_date" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   min="{{ today }}">
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-medium mb-2">
                                Telegram Chat ID (–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
                            </label>
                            <input type="text" name="telegram_chat_id"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="–ü—Ä–∏–º–µ—Ä: 123456789">
                            <p class="text-xs text-gray-500 mt-1">
                                –ü–æ–ª—É—á–∏—Ç–µ ID —á–µ—Ä–µ–∑ –±–æ—Ç–∞ @getmyid_bot
                            </p>
                        </div>
                        
                        <button type="submit"
                                class="w-full bg-blue-600 text-white font-medium py-2.5 px-4 rounded-md hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-save mr-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                        </button>
                    </form>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ -->
                <div class="bg-blue-50 rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-3">
                        <i class="fas fa-robot mr-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    </h3>
                    <p class="text-blue-700 mb-4">
                        –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∑–∞ 7, 3 –∏ 1 –¥–µ–Ω—å –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å—Ä–æ–∫–∞.
                    </p>
                    <div class="bg-white rounded p-3 mb-4">
                        <p class="text-sm font-medium text-gray-700 mb-1">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞:</p>
                        {% if bot_available %}
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">
                            <i class="fas fa-check-circle mr-1"></i>–ê–∫—Ç–∏–≤–µ–Ω
                        </span>
                        {% else %}
                        <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-medium">
                            <i class="fas fa-exclamation-triangle mr-1"></i>–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
                        </span>
                        {% endif %}
                    </div>
                    <a href="https://t.me/getmyid_bot" target="_blank"
                       class="block w-full text-center bg-blue-100 text-blue-700 font-medium py-2 px-4 rounded-md hover:bg-blue-200 transition duration-200">
                        <i class="fab fa-telegram mr-2"></i>–ü–æ–ª—É—á–∏—Ç—å Telegram ID
                    </a>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800">
                            <i class="fas fa-list mr-2"></i>–°–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π
                        </h2>
                        <p class="text-gray-600 text-sm mt-1">
                            –í—Å–µ–≥–æ: {{ total_count }} | –ê–∫—Ç–∏–≤–Ω—ã—Ö: {{ active_count }} | –°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞—é—Ç: {{ expiring_count }}
                        </p>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–§–ò–û</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¢–∏–ø</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ù–∞—á–∞–ª–æ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–û—Å—Ç–∞–ª–æ—Å—å</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for power in powers %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="font-medium text-gray-900">{{ power.full_name }}</div>
                                        {% if power.telegram_chat_id %}
                                        <div class="text-xs text-gray-500">
                                            <i class="fab fa-telegram mr-1"></i>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">
                                            {{ power.poa_type }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">{{ power.start_date }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap font-medium">{{ power.end_date }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="countdown" data-end-date="{{ power.end_date }}"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <button onclick="deletePower({{ power.id }})"
                                                class="text-red-600 hover:text-red-900 text-sm font-medium">
                                            <i class="fas fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        {% if not powers %}
                        <div class="text-center py-12">
                            <i class="fas fa-inbox text-gray-300 text-4xl mb-4"></i>
                            <p class="text-gray-500">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π</p>
                            <p class="text-gray-400 text-sm mt-2">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å –ø–æ–º–æ—â—å—é —Ñ–æ—Ä–º—ã —Å–ª–µ–≤–∞</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-3 rounded-lg mr-4">
                                <i class="fas fa-file-contract text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">–í—Å–µ–≥–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π</p>
                                <p class="text-2xl font-bold text-gray-800">{{ total_count }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex items-center">
                            <div class="bg-green-100 p-3 rounded-lg mr-4">
                                <i class="fas fa-bell text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">–° —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏</p>
                                <p class="text-2xl font-bold text-gray-800">{{ with_notifications }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex items-center">
                            <div class="bg-yellow-100 p-3 rounded-lg mr-4">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">–ò—Å—Ç–µ–∫–∞—é—Ç –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</p>
                                <p class="text-2xl font-bold text-gray-800">{{ expiring_this_month }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –§—É—Ç–µ—Ä -->
        <div class="mt-8 pt-6 border-t border-gray-200 text-center text-gray-500 text-sm">
            <p>–¢—Ä–µ–∫–µ—Ä –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π ‚Ä¢ –†–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –Ω–∞ Railway ‚Ä¢ 
                <a href="/api/docs" class="text-blue-600 hover:text-blue-800">API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a>
            </p>
        </div>
    </div>
</body>
</html>
"""

# ==================== API ENDPOINTS ====================
@app.get("/", response_class=HTMLResponse)
async def read_root():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º"""
    powers = get_all_powers()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    today = date.today()
    end_of_month = date(today.year, today.month, 1) + timedelta(days=32)
    end_of_month = date(end_of_month.year, end_of_month.month, 1) - timedelta(days=1)
    
    expiring_this_month = sum(1 for p in powers 
                             if today <= datetime.strptime(p['end_date'], '%Y-%m-%d').date() <= end_of_month)
    
    context = {
        "powers": powers,
        "today": today.isoformat(),
        "total_count": len(powers),
        "active_count": sum(1 for p in powers if datetime.strptime(p['end_date'], '%Y-%m-%d').date() >= today),
        "expiring_count": sum(1 for p in powers if 0 <= p['days_remaining'] <= 7),
        "with_notifications": sum(1 for p in powers if p['telegram_chat_id']),
        "expiring_this_month": expiring_this_month,
        "bot_available": bool(TELEGRAM_BOT_TOKEN)
    }
    
    import jinja2
    template = jinja2.Template(HTML_TEMPLATE)
    return template.render(**context)

@app.post("/api/powers/", response_model=Dict[str, Any])
async def create_power(power: PowerOfAttorneyCreate):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏"""
    power_id = add_power_of_attorney(
        full_name=power.full_name,
        poa_type=power.poa_type,
        end_date=power.end_date,
        telegram_chat_id=power.telegram_chat_id
    )
    
    return {
        "id": power_id,
        "message": "–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞",
        "full_name": power.full_name,
        "end_date": power.end_date.isoformat()
    }

@app.get("/api/powers/", response_model=List[Dict[str, Any]])
async def read_powers():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π"""
    return get_all_powers()

@app.get("/api/powers/expiring/")
async def get_expiring(
    days: int = Query(7, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏")
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π, –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π"""
    return get_expiring_powers(days)

@app.delete("/api/powers/{power_id}")
async def delete_power_by_id(power_id: int):
    """–£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ ID"""
    success = delete_power(power_id)
    if not success:
        raise HTTPException(status_code=404, detail="–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    return {"message": "–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞", "id": power_id}

@app.post("/api/check-now/")
async def check_now():
    """–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    await scheduler.check_and_notify()
    return {"message": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"}

@app.get("/api/health/")
async def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "database": os.path.exists(DATABASE_FILE),
        "telegram_bot": bool(TELEGRAM_BOT_TOKEN),
        "total_powers": len(get_all_powers())
    }

# ==================== –ó–ê–ü–£–°–ö ====================
if __name__ == "__main__":
    import uvicorn
    
    print("=" * 50)
    print("üöÄ –¢—Ä–µ–∫–µ—Ä –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π")
    print("=" * 50)
    print(f"–î–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {DATABASE_FILE}")
    print(f"Telegram –±–æ—Ç: {'–ù–∞—Å—Ç—Ä–æ–µ–Ω' if TELEGRAM_BOT_TOKEN else '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}")
    print(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ –¥–Ω–µ–π: {NOTIFICATION_DAYS}")
    print("=" * 50)
    print("–î–æ—Å—Ç—É–ø–Ω—ã–µ URL:")
    print(f"  ‚Ä¢ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:8000")
    print(f"  ‚Ä¢ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/api/docs")
    print(f"  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è: http://localhost:8000/api/health")
    print("=" * 50)
    
    uvicorn.run(
        "poa_tracker:app",
        host="0.0.0.0",
        port=int(os.getenv("PORT", 8000)),
        reload=True
    )
